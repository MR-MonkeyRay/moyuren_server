<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‘¸é±¼æ—¥å† {{ date.year_month }} - æ‚å¿—é£æ ¼ç‰ˆ</title>
    <style>
        :root {
            /* è«å…°è¿ª/æ‚å¿—é£é…è‰² */
            --bg-body: #E0E5EC;
            --bg-paper: #F7F9F9;

            --text-dark: #2C3E50;
            --text-grey: #7F8C8D;
            --text-light: #95A5A6;

            --accent-blue: #D6EAF8;
            --accent-blue-text: #2E86C1;

            --accent-green: #D5F5E3;
            --accent-green-text: #27AE60;

            --accent-pink: #FADBD8;
            --accent-pink-text: #C0392B;

            --card-radius: 16px;
            --spacing: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-body);
            font-family: 'PingFang SC', 'Helvetica Neue', sans-serif;
            min-height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 22px 0;
        }

        /* æ ¸å¿ƒå®¹å™¨ï¼šé”å®šA4æ¯”ä¾‹ï¼Œé«˜åº¦è‡ªé€‚åº”å±å¹• */
        .poster {
            width: 90vw;
            max-width: 760px;
            min-height: 1030px;
            background-color: var(--bg-paper);
            border-radius: 8px;
            box-shadow: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: var(--spacing);
            color: var(--text-dark);
        }

        /* é€šç”¨å¡ç‰‡é£æ ¼ */
        .box {
            background: #FFFFFF;
            border-radius: var(--card-radius);
            padding: 20px;
            /* æŸ”å’Œçš„æŠ•å½±è®©å¡ç‰‡æµ®èµ·æ¥ */
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
        }

        h2 {
            font-size: 20px;
            color: var(--text-grey);
            font-weight: 600;
            margin-bottom: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- ç¬¬ä¸€æ’ï¼šå¤´éƒ¨ (å›ºå®šé«˜åº¦) --- */
        .row-header {
            height: 170px;
            flex-shrink: 0;
            display: flex;
            gap: var(--spacing);
        }

        .title-card {
            flex: 0.35;
            background-color: var(--text-dark);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .moyu-text { font-size: 45px; font-weight: 900; line-height: 1.1; letter-spacing: 4px; }
        .moyu-sub { font-size: 14px; font-weight: 300; opacity: 0.8; margin-top: 8px; letter-spacing: 2px; }

        .date-card {
            flex: 0.65;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
        }
        .date-left { display: flex; flex-direction: column; }
        .big-day { font-size: 80px; font-weight: 800; color: var(--text-dark); line-height: 1; }
        .ym-text { font-size: 22px; color: var(--text-grey); font-weight: 500; }

        .date-right { text-align: right; }
        .week-pill {
            background: var(--accent-blue); color: var(--accent-blue-text);
            padding: 6px 16px; border-radius: 20px; font-weight: bold; font-size: 18px;
            display: inline-block; margin-bottom: 8px;
        }
        .lunar-text { font-size: 16px; color: var(--text-grey); }
        
        .weekend-wrap { margin-top: 10px; font-size: 14px; color: var(--text-grey); display: flex; align-items: baseline; justify-content: flex-end; }
        .weekend-num { font-size: 20px; font-weight: 800; color: #E67E22; margin: 0 4px; }

        /* --- ç¬¬äºŒæ’ï¼šä¿¡æ¯ (å¼¹æ€§) --- */
        .row-info {
            height: 215px;
            flex-shrink: 0;
            display: flex;
            gap: var(--spacing);
        }

        .term-card {
            flex: 0.4;
            background: linear-gradient(135deg, #ffffff 0%, #fcfdfc 100%);
            display: flex;
            flex-direction: column;
        }
        .countdown-wrap { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .term-name-cn { font-size: 32px; font-weight: 800; color: var(--accent-green-text); line-height: 1.2; }
        .term-name-en { font-size: 14px; color: var(--text-light); margin-bottom: 8px; font-weight: 500; }
        .days-label { font-size: 16px; color: var(--text-grey); display: flex; align-items: baseline; }
        .days-num { font-size: 24px; font-weight: 700; color: var(--text-dark); margin: 0 4px; }

        .yi-ji-row {
            display: flex; flex-direction: column; gap: 8px; font-size: 13px; border-top: 1px dashed #eee; padding-top: 10px;
        }
        .yi-ji-row > div { display: flex; align-items: center; line-height: 1.4; }
        .tag { padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 8px; flex-shrink: 0; font-size: 12px; }
        .tag.yi { background: #E8F8F5; color: #1ABC9C; }
        .tag.ji { background: #FDEDEC; color: #E74C3C; }

        .history-card {
            flex: 0.6;
            display: flex;
            flex-direction: column;
        }
        .history-content {
            flex: 1;
            font-size: 17px;
            line-height: 1.6;
            color: #555;
            display: flex;
            align-items: center;
            text-align: justify;
        }
        .joke-tag { font-size: 14px; color: #aaa; margin-top: auto; text-align: right; font-style: italic; }

        /* --- ç¬¬ä¸‰æ’ï¼šä¸»è¦å†…å®¹ (å æ®å‰©ä½™æ‰€æœ‰ç©ºé—´) --- */
        .row-main {
            flex: 1; /* å…³é”®ï¼šè‡ªåŠ¨å¡«å……å‰©ä½™é«˜åº¦ */
            display: flex;
            gap: var(--spacing);
            /* min-height: 0;  Removed to allow growth */
        }

        .news-card {
            flex: 0.6;
            display: flex;
            flex-direction: column;
        }
        .news-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* å‡åŒ€åˆ†å¸ƒ */
            list-style: none;
        }
        .news-item {
            font-size: 15px;
            padding-bottom: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
        }
        .news-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .news-num {
            color: var(--accent-blue-text); font-size: 14px; width: 1.5em; flex-shrink: 0; font-weight: 800;
            font-family: 'Courier New', Courier, monospace;
        }
        .news-text {
            color: #444;
            /* å–æ¶ˆæˆªæ–­ï¼Œæ˜¾ç¤ºå®Œæ•´å†…å®¹ */
            line-height: 1.4;
        }

        .holiday-card {
            flex: 0.4;
            background-color: #FFFFFF; /* ç™½è‰²èƒŒæ™¯ */
            display: flex;
            flex-direction: column;
            overflow: hidden;  /* é˜²æ­¢æº¢å‡º */
        }
        .holiday-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px; /* å‡å°é—´è·é€‚é…æ›´å¤šæ¡ç›® */
            overflow: hidden;  /* è¶…å‡ºéšè— */
        }
        .holiday-item {
            padding: 6px 12px; /* è°ƒæ•´å†…è¾¹è· */
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease-in-out;
            border-left: 3px solid transparent; /* é»˜è®¤é€æ˜è¾¹æ¡†å ä½ */
        }
        /* æ³•å®šèŠ‚å‡æ—¥ - çªå‡º */
        .holiday-item.legal {
            background: linear-gradient(135deg, #FFF5E6 0%, #FFEDD5 100%);
            border-left: 3px solid #E67E22;
            box-shadow: 0 2px 8px rgba(230, 126, 34, 0.1);
        }
        /* éæ³•å®šèŠ‚å‡æ—¥ - æ·¡åŒ– */
        .holiday-item.normal {
            background: #F8F9F9;
            opacity: 0.8;
        }
        .h-info { display: flex; flex-direction: column; justify-content: center; }
        .h-name { font-size: 14px; font-weight: 700; color: #333; }
        .holiday-item.normal .h-name { font-weight: 500; color: #555;}
        .h-date { font-size: 11px; color: #999; margin-top: 2px; }

        .h-count-wrap { text-align: right; }
        .h-num { font-size: 27px; font-weight: 800; }
        .h-unit { font-size: 9px; color: var(--text-light); }

        /* å€’è®¡æ—¶é¢œè‰² */
        .h-num.urgent { color: #E74C3C; }  /* â‰¤7å¤© çº¢è‰² */
        .h-num.soon { color: #E67E22; }    /* 7-30å¤© æ©™è‰² */
        .h-num.later { color: #2C3E50; }   /* >30å¤© æ·±ç°è‰² */
        .holiday-item.normal .h-num { color: #95A5A6; } /* éæ³•å®šå‡æ—¥ç»Ÿä¸€ç”¨æµ…è‰² */

        /* é¡µè„šæ•´ä½“å®¹å™¨ */
        .footer-wrapper {
            margin-top: auto;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            width: 100%;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.03);
            font-size: 10px;
            color: var(--text-light);
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
        }

        .footer-left { text-align: left; }
        .footer-center { text-align: center; }
        .footer-right { text-align: right; }

        /* --- ç¬¬å››æ’ï¼šç‰¹è‰²æ¿å— (ç–¯ç‹‚æ˜ŸæœŸå››) --- */
        .row-special {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: #FFFFFF;
            border-radius: var(--card-radius);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
            /* ç¨å¾®åŠ ä¸€ç‚¹çº¢è‰²æ°›å›´ */
            background: linear-gradient(135deg, #fffcfc 0%, #fff5f5 100%);
            border-left: 4px solid #C0392B; /* è‚¯å¾·åŸºçº¢ */
            margin-bottom: 8px;
        }

        .kfc-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            border-bottom: 1px dashed rgba(192, 57, 43, 0.2);
            padding-bottom: 10px;
        }

        .kfc-icon {
            font-size: 28px;
            background: #FDEDEC;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .kfc-titles {
            display: flex;
            flex-direction: column;
        }

        .kfc-title-en {
            font-size: 18px;
            font-weight: 900;
            color: #C0392B;
            letter-spacing: 1px;
            font-family: 'Arial Black', sans-serif;
            line-height: 1;
        }

        .kfc-title-cn {
            font-size: 12px;
            color: #E74C3C;
            letter-spacing: 4px;
            font-weight: bold;
            margin-top: 4px;
        }

        .kfc-body {
            font-size: 14px;
            line-height: 1.5;
            color: #555;
            text-align: justify;
            /* ç§»é™¤é«˜åº¦é™åˆ¶ï¼Œå®Œæ•´æ˜¾ç¤ºå†…å®¹ */
            font-style: italic;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* æ‰“å°æ ·å¼ */
        @media print {
            body { background: white; height: auto; overflow: visible; }
            .poster {
                width: 100%; height: 100%;
                box-shadow: none; padding: 0;
                aspect-ratio: auto;
            }
            .box { border: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <div class="poster">

        <!-- ç¬¬ä¸€æ’ï¼šæ ‡é¢˜ä¸æ—¥æœŸ -->
        <div class="row-header">
            <div class="box title-card">
                <div class="moyu-text">æ‘¸é±¼<br>æ—¥å†</div>
                <div class="moyu-sub">MOYU CALENDAR</div>
            </div>
            <div class="box date-card">
                <div class="date-left">
                    <div class="ym-text">{{ date.year_month }}</div>
                    <div class="big-day">{{ date.day }}</div>
                </div>
                <div class="date-right">
                    <div class="week-pill">{{ date.week_cn }} Â· {{ date.week_en }}</div>
                    <div class="lunar-text">å†œå† {{ date.lunar_year }}</div>
                    <div class="lunar-text">{{ date.lunar_date }}</div>
                    <div class="weekend-wrap">
                        â³ è·å‘¨æœ«è¿˜æœ‰ <span class="weekend-num">{{ weekend.days_left }}</span> å¤©
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒæ’ï¼šèŠ‚æ°”ä¸å®œå¿Œ -->
        <div class="row-info">
            <div class="box term-card">
                <h2>ğŸŒ¿ ä¸‹ä¸ªèŠ‚æ°”</h2>
                <div class="countdown-wrap">
                    <div class="term-name-cn">{{ solar_term.name }}</div>
                    <div class="term-name-en">{{ solar_term.name_en }}</div>
                    <div class="days-label">è¿˜æœ‰ <span class="days-num">{{ solar_term.days_left }}</span> å¤©</div>
                </div>
                <div class="yi-ji-row">
                    <div><span class="tag yi">å®œ</span>{% for item in guide.yi %}{{ item }} {% endfor %}</div>
                    <div><span class="tag ji">å¿Œ</span>{% for item in guide.ji %}{{ item }} {% endfor %}</div>
                </div>
            </div>
            <div class="box history-card">
                <h2>{{ history.title }}</h2>
                <div class="history-content">{{ history.content }}</div>
                <div class="joke-tag">â€”â€” æ‘¸é±¼åŠå®£</div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰æ’ï¼šæ–°é—»ä¸å‡æœŸ -->
        <div class="row-main">
            <div class="box news-card">
                <h2>ğŸ“° æ¯æ—¥ 60s é€Ÿè§ˆ</h2>
                <ul class="news-list" id="news-list">
                    {% for item in news_list %}
                    <li class="news-item"><span class="news-num">{{ item.num }}</span><span class="news-text">{{ item.text }}</span></li>
                    {% endfor %}
                </ul>
            </div>

            <div class="box holiday-card">
                <h2>ğŸ–ï¸ å‡æœŸç›¼å¤´</h2>
                <div class="holiday-list">
                    {% for holiday in holidays %}
                    <div class="holiday-item {{ 'legal' if holiday.is_legal_holiday else 'normal' }}">
                        <div class="h-info">
                            <div class="h-name">{% if holiday.is_legal_holiday %}ğŸ‰ {% endif %}{{ holiday.name }}</div>
                            <div class="h-date">
                                {{ holiday.start_date }}
                                {% if holiday.duration > 1 %}
                                ~ {{ holiday.end_date }} ({{ holiday.duration }}å¤©)
                                {% endif %}
                            </div>
                        </div>
                        <div class="h-count-wrap">
                            <div class="h-num {% if holiday.is_legal_holiday %}{% if holiday.days_left <= 7 %}urgent{% elif holiday.days_left <= 30 %}soon{% else %}later{% endif %}{% endif %}">{{ holiday.days_left }}</div>
                            <div class="h-unit">DAYS</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- ç¬¬å››æ’ï¼šç–¯ç‹‚æ˜ŸæœŸå›› (ä»…å‘¨å››æ˜¾ç¤º) -->
        {% if kfc_content %}
        <div class="row-special kfc-card">
            <div class="kfc-header">
                <div class="kfc-icon">ğŸ—</div>
                <div class="kfc-titles">
                    <div class="kfc-title-en">{{ kfc_content.title }}</div>
                    <div class="kfc-title-cn">{{ kfc_content.sub_title }}</div>
                </div>
            </div>
            <div class="kfc-body">{{ kfc_content.content }}</div>
        </div>
        {% endif %}

        <!-- é¡µè„šåŒºåŸŸ -->
        <div class="footer-wrapper">
            <div class="footer-left">
                {{ github_url | default('MR-MonkeyRay/moyuren_server') }}
            </div>
            
            <div class="footer-center">
                {% if news_meta and news_meta.updated %}
                æ•°æ®æ›´æ–°äº {{ news_meta.updated }}
                {% endif %}
            </div>

            <div class="footer-right">
                {{ version | default('v0.1.0') }}
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const holidayList = document.querySelector('.holiday-list');
            if (!holidayList) return;

            const holidayItems = Array.from(holidayList.children);
            if (holidayItems.length === 0) return;

            const setVisibleHolidays = () => {
                // Reset display for all items for recalculation
                holidayItems.forEach(item => item.style.display = '');

                const listMaxHeight = holidayList.clientHeight;
                const listGap = parseFloat(window.getComputedStyle(holidayList).gap) || 0;
                let accumulatedHeight = 0;

                for (let i = 0; i < holidayItems.length; i++) {
                    const item = holidayItems[i];
                    const itemHeight = item.offsetHeight;
                    
                    let heightWithGap = itemHeight;
                    if (i > 0) {
                        heightWithGap += listGap;
                    }

                    // Use a small buffer (1px) to prevent floating point inaccuracies
                    if (accumulatedHeight + heightWithGap > listMaxHeight + 1) {
                        for (let j = i; j < holidayItems.length; j++) {
                            holidayItems[j].style.display = 'none';
                        }
                        break;
                    }
                    accumulatedHeight += heightWithGap;
                }
            };

            const run = () => {
                // Wait for fonts to load before calculating heights
                // Fallback to rAF for older browsers without FontFaceSet API
                if (document.fonts && document.fonts.ready) {
                    document.fonts.ready.then(() => {
                        requestAnimationFrame(setVisibleHolidays);
                    });
                } else {
                    requestAnimationFrame(() => {
                        requestAnimationFrame(setVisibleHolidays);
                    });
                }
            };

            run();

            // Re-run on window resize, debounced
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(run, 150);
            });
        });
    </script>
</body>
</html>
