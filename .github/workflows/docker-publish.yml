name: Build and Publish Docker Image

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate version tags
        id: version
        run: |
          # 获取短 commit SHA
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          # 初始化变量
          IS_TAG=false
          IS_MAIN=false
          VERSION=""
          SUFFIX=""

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag 触发：提取版本号
            IS_TAG=true
            VERSION="${{ github.ref_name }}"
            # 清理版本号中的特殊字符（防止 v1.0/rc 这类带斜杠的 tag）
            VERSION=$(echo "${VERSION}" | sed 's|/|-|g' | sed 's/[^a-zA-Z0-9._-]/-/g')

            # 检查 tag 是否在 main 分支上（精确匹配，避免误匹配 main-foo）
            if git branch -r --contains "${{ github.sha }}" | grep -qE '^\s*origin/main$'; then
              IS_MAIN=true
            fi
          elif [[ "${{ github.ref }}" == refs/heads/* ]]; then
            # 分支触发
            BRANCH="${{ github.ref_name }}"
            VERSION="${SHORT_SHA}"

            if [[ "${BRANCH}" == "main" ]]; then
              IS_MAIN=true
            else
              # 生成分支后缀：将 / 替换为 -，保留完整路径避免冲突
              # feat/xxx -> feat-xxx, fix/yyy -> fix-yyy, develop -> develop
              SUFFIX=$(echo "${BRANCH}" | sed 's|/|-|g')
              # 清理后缀中的特殊字符（Docker tag 只允许 [a-zA-Z0-9._-]）
              SUFFIX=$(echo "${SUFFIX}" | sed 's/[^a-zA-Z0-9._-]/-/g')
            fi
          fi

          # 构建标签列表
          TAGS=""

          if [[ "${IS_TAG}" == "true" ]]; then
            # Tag 触发：推送版本号标签
            TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"

            # 只有 main 分支的 tag 才推送 latest
            if [[ "${IS_MAIN}" == "true" ]]; then
              TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            fi
          elif [[ "${IS_MAIN}" == "true" ]]; then
            # main 分支 push：推送 latest 和 SHA
            TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
          else
            # 其他分支：推送带后缀的标签
            TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}-${SUFFIX}"
            TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-${SUFFIX}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "is_main=${IS_MAIN}" >> $GITHUB_OUTPUT
          echo "is_tag=${IS_TAG}" >> $GITHUB_OUTPUT
          echo "Generated tags: ${TAGS}"

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.version.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
